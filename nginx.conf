# README:
# To adjust the  configuration file, please do the following:
# - replace host.docker.internal with the IP address of the backend server
# - replace wz.itsenergy.biz with the domain name of the server
# NOTE: you need to have the SSL certificate and key files in the /etc/nginx/certs directory
#       if the cert and key file names are different then the domain - set them in ssl_certificate and ssl_certificate_key
#       you need to have a crt and key file, if you don't have them separate - please extract using openssl or other method
#       if you don't have the cert, you can generate one and add it's root as trusted in your PC or use one issued by a trusted party

worker_processes auto;

events {
  worker_connections  1024;  ## Default: 1024
}
http {
  default_type application/octet-stream;

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
  '$status $body_bytes_sent "$http_referer" '
  '"$http_user_agent" "$http_x_forwarded_for"';

  sendfile on;
  keepalive_timeout      99;
  client_header_timeout  3m;
  client_body_timeout    3m;
  send_timeout     3m;
  client_max_body_size 150M;
  proxy_headers_hash_max_size 512;

  server {
    listen 443 ssl;
    # allow host.docker.internal;
    server_name test.pqmdev.onmicrosoft.com;

    #ssl_certificate /nginx-1.24.0/conf/cert/local.crt;
    #ssl_certificate_key /nginx-1.24.0/conf/cert/local.key;
    ssl_certificate /etc/nginx/certs/test.pqmdev.onmicrosoft.com.crt;
    ssl_certificate_key /etc/nginx/certs/test.pqmdev.onmicrosoft.com.key;
    ssl_session_cache builtin:9900 shared:SSL:10m;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    #client_max_body_size 12m;

    #add_header Accept */*;
    # add_header Access-Control-Allow-Credentials true;
    # add_header Access-Control-Allow-Origin * always;
    # add_header Access-Control-Allow-Headers Authorization,Accept,Origin,DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Range,Range;
    # add_header Access-Control-Allow-Methods GET,POST,OPTIONS,PUT,DELETE,PATCH;

    # OLD CLIENT
    location ^~ /app/client/ {
      proxy_pass http://host.docker.internal:5010/app/client/;
    }
		
		# OLD CLIENT DEV MODE
		location ^~ /app/client-dev/ {
			proxy_pass  http://127.0.0.1:8080/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			set $best_http_host $http_host;
			set $pass_server_port $server_port;
			set $pass_port $pass_server_port;
			set $pass_access_scheme $scheme;
 
			proxy_set_header X-Forwarded-For $remote_addr;
			proxy_set_header X-Forwarded-Host $best_http_host;
			proxy_set_header X-Forwarded-Port $pass_port;
			proxy_set_header X-Forwarded-Proto $pass_access_scheme;
			proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
			proxy_set_header X-Scheme $pass_access_scheme;
		}

    # CONFIGURATOR
    location ^~ /app/configurator/ {
      proxy_pass http://host.docker.internal:5009/app/configurator/;
    }

    # CONFIGURATOR DEV MODE
    location ^~ /app/configurator-dev/ {
      proxy_pass  http://127.0.0.1:8082/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;
    }

    # NEXTGEN CLIENT
    location ^~ /client {
      proxy_pass http://host.docker.internal:5011/client;
    }

    # NOVA CLIENT
    location ^~ /nova {
      proxy_pass http://host.docker.internal:5013/nova;
    }

    # NOVA CLIENT DEV MODE
    location ^~ /nova-dev {
      proxy_pass http://localhost:3000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }

    # ODATA
    location ^~ /odata {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5001/odata/;
    }

    location ^~ /odata/ {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5001/odata/;
    }

    # ODATAV4
    location ^~ /odata4 {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5004/odata4/;
    }

    location ^~ /odata4/ {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5004/odata4/;
    }

    # EXPLORER
    location ^~ /explorer {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5005/explorer/;
    }

    location ^~ /explorer/ {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5005/explorer/;
    }

    # SCIM
    location ^~ /provisioning/scim/token {
      proxy_pass http://host.docker.internal:5003/provisioning/scim/token;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Contact lookup
    location ^~ /contactlookup {
      proxy_pass http://host.docker.internal:5034/contactlookup;
    }
    location ^~ /contactsyncconfigservice {
      proxy_pass http://host.docker.internal:5123/contactsyncconfigservice;
    }
    location ^~ /contactsyncconfigservice/api/v1/ContactSyncConfiguration/configurationinfos {
      proxy_pass http://host.docker.internal:5123/contactsyncconfigservice/api/v1/ContactSyncConfiguration/configurationinfos;
    }
    # WZPS
    
    location ^~ /secretservice {
      proxy_pass http://host.docker.internal:5124/secretservice;
    }

    # DEV PDF
    location ^~ /render/ {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://172.25.4.184:5006/render/;
    }

    location ^~ /render {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://172.25.4.184:5006/render;
    }

    # OAUTH2
    location ^~ /oauth2 {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5000/oauth2/;
    }
    location ^~ /oauth2/ {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      set $best_http_host $http_host;
      set $pass_server_port $server_port;
      set $pass_port $pass_server_port;
      set $pass_access_scheme $scheme;

      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header X-Forwarded-Host $best_http_host;
      proxy_set_header X-Forwarded-Port $pass_port;
      proxy_set_header X-Forwarded-Proto $pass_access_scheme;
      proxy_set_header X-Forwarded-Scheme $pass_access_scheme;
      proxy_set_header X-Scheme $pass_access_scheme;

      proxy_pass http://host.docker.internal:5000/oauth2/;
    }

    # ERRORS
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
      root /usr/share/nginx/html;
    }
  }

# Reverse Proxy Setup for the Backend
}